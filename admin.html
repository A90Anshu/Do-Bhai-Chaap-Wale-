<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest-admin.json">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#e91e63">
  <title>Admin Dashboard | Do Bhai Chaap Wale</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --primary: #e91e63;
      --primary-dark: #c2185b;
      --bg-light: #f4f7fa;
      --sidebar-bg: #2d3436;
      --text-main: #333;
      --text-light: #777;
      --card-shadow: 0 4px 15px rgba(0,0,0,0.05);
      --success: #00b894;
      --warning: #fdcb6e;
      --info: #0984e3;
    }

    * { box-sizing: border-box; outline: none; }
    body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-light); color: var(--text-main); height: 100vh; overflow: hidden; }

    /* --- LOGIN SCREEN --- */
    #login-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #2d3436, #000);
      display: flex; justify-content: center; align-items: center; z-index: 1000;
    }
    .login-card {
      background: #fff; padding: 40px; border-radius: 12px;
      width: 90%; max-width: 400px; text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .login-card h2 { color: var(--primary); margin-bottom: 5px; }
    .login-card input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin: 10px 0; font-size: 1rem; }
    .login-card button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; margin-top: 10px; }
    .login-card button:hover { background: var(--primary-dark); }
    .remember-me { display: flex; align-items: center; gap: 8px; margin: 10px 0; font-size: 0.9rem; color: #555; justify-content: center; }

    /* --- DASHBOARD LAYOUT --- */
    #dashboard { display: flex; height: 100vh; }
    
    /* Sidebar */
    aside {
      width: 260px; background: var(--sidebar-bg); color: #fff;
      display: flex; flex-direction: column; padding: 25px;
      transition: all 0.3s;
    }
    aside h1 { font-size: 1.3rem; text-align: center; margin-bottom: 40px; color: var(--primary); border-bottom: 1px solid #444; padding-bottom: 20px; font-weight: 700; }
    
    .nav-item {
      padding: 15px 20px; margin-bottom: 12px; border-radius: 8px;
      cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px;
      background: rgba(255,255,255,0.05); font-size: 0.95rem;
      border-left: 4px solid transparent;
    }
    .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); border-left-color: var(--primary); }
    .nav-item i { width: 20px; text-align: center; }
    
    /* Main Content */
    main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
    
    /* --- VIEW SECTIONS --- */
    .view-section { display: none; animation: fadeIn 0.3s ease; }
    .view-section.active { display: block; }

    /* --- STATS CARDS (Top Bar) --- */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); border-left: 5px solid var(--primary); }
    .stat-card h3 { margin: 0 0 5px; font-size: 0.9rem; color: var(--text-light); }
    .stat-card .val { font-size: 1.8rem; font-weight: 700; color: var(--text-main); }
    
    /* --- CONTROLS & TABS --- */
    .controls-bar {
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;
      background: #fff; padding: 10px 20px; border-radius: 12px; box-shadow: var(--card-shadow);
    }
    
    .status-tabs { display: flex; gap: 10px; }
    .status-tab {
      padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: #555; border: 1px solid transparent; transition: all 0.2s;
    }
    .status-tab.active { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(233,30,99,0.3); }
    .status-tab:hover:not(.active) { background: #eee; }
    
    .tab-badge { background: #fff; color: var(--primary); padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 5px; font-weight: 700; }
    .status-tab.active .tab-badge { background: rgba(255,255,255,0.2); color: #fff; }

    .action-btn {
      padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
    }
    .btn-sound { background: #636e72; color: white; }
    .btn-sound.active { background: var(--success); animation: pulse 2s infinite; }

    /* --- TABLE --- */
    .table-container { background: #fff; border-radius: 12px; box-shadow: var(--card-shadow); overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    thead { background: #f8f9fa; border-bottom: 2px solid #eee; }
    th { text-align: left; padding: 15px; font-size: 0.85rem; color: var(--text-light); font-weight: 600; }
    td { padding: 15px; border-bottom: 1px solid #f1f1f1; vertical-align: middle; font-size: 0.9rem; }
    tr:hover { background: #fdfdfd; }
    
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-top: 5px; }
    .badge-type { background: rgba(9, 132, 227, 0.1); color: var(--info); border: 1px solid var(--info); }
    
    /* Action Buttons in Table */
    .btn-table { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; margin-right: 5px; font-weight: 500; color: #fff; transition: transform 0.1s; }
    .btn-table:active { transform: scale(0.95); }
    .btn-accept { background: var(--success); }
    .btn-ready { background: var(--primary); }
    .btn-map { background: var(--info); }

    .items-list { font-size: 0.85rem; color: #555; line-height: 1.4; }
    
    /* --- PAYOUTS VIEW --- */
    .payout-card { background: #fff; padding: 30px; border-radius: 12px; box-shadow: var(--card-shadow); text-align: center; max-width: 600px; margin: 0 auto; }
    .payout-val { font-size: 3rem; font-weight: 800; color: var(--primary); margin: 20px 0; }
    .payout-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }

    .hidden { display: none !important; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0,184,148,0.7); } 70% { box-shadow: 0 0 0 10px rgba(0,184,148,0); } 100% { box-shadow: 0 0 0 0 rgba(0,184,148,0); } }
  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="login-card">
      <h2>Admin Panel</h2>
      <p style="color:#777; margin-bottom:20px;">Do Bhai Chaap Wale</p>
      
      <input type="text" id="adminUser" placeholder="Username">
      <input type="password" id="adminPass" placeholder="Password">
      
      <div class="remember-me">
        <input type="checkbox" id="rememberCheck"> <label for="rememberCheck">Remember Me</label>
      </div>

      <button onclick="login()">Login</button>
      <p id="loginError" style="color:red; margin-top:10px; font-size:0.9rem;"></p>
    </div>
  </div>

  <div id="dashboard" class="hidden">
    <aside>
      <h1><i class="fas fa-utensils"></i> Do Bhai Chaap</h1>
      
      <div class="nav-item active" onclick="switchView('orders')">
        <i class="fas fa-list-alt"></i> Live Orders
      </div>
      
      <div class="nav-item" onclick="switchView('payouts')">
        <i class="fas fa-chart-line"></i> Payouts & Stats
      </div>

      <div class="nav-item" onclick="exportCSV()">
        <i class="fas fa-file-download"></i> Export Data
      </div>
      
      <div class="nav-item" onclick="logout()" style="margin-top:auto; background:rgba(233,30,99,0.1); color:#e91e63;">
        <i class="fas fa-sign-out-alt"></i> Logout
      </div>
    </aside>

    <main>
      
      <div id="view-orders" class="view-section active">
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Pending</h3>
            <div class="val" id="stat-pending" style="color:#d35400">0</div>
          </div>
          <div class="stat-card" style="border-left-color: #0984e3;">
            <h3>Today's Orders</h3>
            <div class="val" id="stat-orders">0</div>
          </div>
          <div class="stat-card" style="border-left-color: #00b894;">
            <h3>Today's Revenue</h3>
            <div class="val" id="stat-today">‚Çπ0</div>
          </div>
        </div>

        <div class="controls-bar">
          <div class="status-tabs">
            <div class="status-tab active" onclick="setFilter('Pending')">
              ‚è≥ Pending <span id="badge-pending" class="tab-badge">0</span>
            </div>
            <div class="status-tab" onclick="setFilter('Accepted')">
              üî• Kitchen <span id="badge-accepted" class="tab-badge">0</span>
            </div>
            <div class="status-tab" onclick="setFilter('Ready')">
              ‚úÖ History
            </div>
          </div>

          <button class="action-btn btn-sound" id="soundBtn" onclick="enableSound()">
            <i class="fas fa-volume-mute"></i> Enable Sound
          </button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Customer</th>
                <th>Order Details</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTable">
              </tbody>
          </table>
        </div>
      </div>

      <div id="view-payouts" class="view-section">
        <h2 style="margin-bottom:20px;">üí∞ Analytics & Payouts</h2>
        
        <div class="payout-card">
          <p style="color:#777; font-weight:600;">LIFETIME REVENUE</p>
          <div class="payout-val" id="pay-total">‚Çπ0</div>
          <p style="font-size:0.9rem; color:#aaa;">From all loaded orders</p>
          
          <div class="payout-grid">
            <div>
              <div style="font-size:1.5rem; font-weight:700; color:#333;" id="pay-count">0</div>
              <div style="font-size:0.8rem; color:#777;">Total Orders</div>
            </div>
            <div>
              <div style="font-size:1.5rem; font-weight:700; color:#333;" id="pay-avg">‚Çπ0</div>
              <div style="font-size:0.8rem; color:#777;">Avg Order Value</div>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // --- 1. CONFIGURATION ---
    const ADMIN_USER = "admin";
    const ADMIN_PASS = "A90Anshu@"; 
    
    const firebaseConfig = {
      apiKey: "AIzaSyADDoSv7Wt8WOfYkcAYZcQOZtCKROuHMu4",
      authDomain: "dobhaichaapwale1.firebaseapp.com",
      projectId: "dobhaichaapwale1",
      storageBucket: "dobhaichaapwale1.firebasestorage.app",
      messagingSenderId: "141034963645",
      appId: "1:141034963645:web:442a93b6e87643b3bf2dd4"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. GLOBAL STATE ---
    let ordersData = [];
    let currentFilter = "Pending";
    let audioCtx = null;
    let ringInterval = null;
    let soundEnabled = false;

    // --- 3. AUTH & LOGIN ---
    // Check if logged in on load
    window.onload = function() {
        if(localStorage.getItem("adminLoggedIn") === "true") {
            showDashboard();
        }
    };

    function login() {
      const user = document.getElementById("adminUser").value;
      const pass = document.getElementById("adminPass").value;
      const remember = document.getElementById("rememberCheck").checked;

      if (user === ADMIN_USER && pass === ADMIN_PASS) {
        if(remember) localStorage.setItem("adminLoggedIn", "true");
        showDashboard();
      } else {
        document.getElementById("loginError").innerText = "Invalid Username or Password";
      }
    }

    function logout() {
        localStorage.removeItem("adminLoggedIn");
        location.reload();
    }

    function showDashboard() {
        document.getElementById("login-overlay").style.display = "none";
        document.getElementById("dashboard").classList.remove("hidden");
        loadOrders();
    }
    
    // --- 4. NAVIGATION ---
    function switchView(viewName) {
        // Update Sidebar Active State
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // (Simple visual update for demo, proper way needs ID matching)
        
        // Switch Section
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewName).classList.add('active');
    }

    // --- 5. DATA LOGIC ---
    function loadOrders() {
      // Listen to 100 most recent orders for analytics
      db.collection("orders").orderBy("created", "desc").limit(100).onSnapshot(snap => {
        ordersData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        ordersData.forEach(o => { if(!o.status) o.status = "Pending"; });

        updateStats();
        updatePayouts();
        renderTable();
        checkRinging(); 
      });
    }

    function updateStats() {
      const pendingCount = ordersData.filter(o => o.status === 'Pending').length;
      document.getElementById("stat-pending").innerText = pendingCount;
      document.getElementById("badge-pending").innerText = pendingCount;
      
      const kitchenCount = ordersData.filter(o => o.status === 'Accepted').length;
      document.getElementById("badge-accepted").innerText = kitchenCount;

      const today = new Date().toDateString();
      const todayRev = ordersData
        .filter(o => o.created && o.created.toDate && o.created.toDate().toDateString() === today)
        .reduce((sum, o) => sum + (Number(o.total) || 0), 0);
        
      document.getElementById("stat-today").innerText = "‚Çπ" + todayRev.toLocaleString('en-IN');
      document.getElementById("stat-orders").innerText = ordersData.length;
    }
    
    function updatePayouts() {
        // Calculate totals from loaded orders
        const totalRev = ordersData.reduce((sum, o) => sum + (Number(o.total) || 0), 0);
        const count = ordersData.length;
        const avg = count > 0 ? Math.round(totalRev / count) : 0;

        document.getElementById("pay-total").innerText = "‚Çπ" + totalRev.toLocaleString('en-IN');
        document.getElementById("pay-count").innerText = count;
        document.getElementById("pay-avg").innerText = "‚Çπ" + avg;
    }

    // --- 6. RENDER TABLE ---
    function setFilter(filter) {
      currentFilter = filter;
      
      // Update Tab UI
      document.querySelectorAll(".status-tab").forEach(el => el.classList.remove("active"));
      // Hacky way to highlight clicked tab
      const tabs = Array.from(document.querySelectorAll(".status-tab"));
      const activeTab = tabs.find(t => t.innerText.includes(filter));
      if(activeTab) activeTab.classList.add("active");

      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById("ordersTable");
      tbody.innerHTML = "";

      let filtered = [];
      if(currentFilter === 'Ready') {
         filtered = ordersData.filter(o => o.status === 'Ready' || o.status === 'Completed');
      } else {
         filtered = ordersData.filter(o => o.status === currentFilter);
      }

      if(filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">No orders in ${currentFilter}</td></tr>`;
        return;
      }

      filtered.forEach(o => {
        let timeStr = "N/A";
        if(o.created && o.created.toDate) {
            timeStr = o.created.toDate().toLocaleTimeString('en-IN', {hour: '2-digit', minute:'2-digit'});
        }

        const itemsHtml = (o.items || []).map(i => `<span>‚Ä¢ ${i.name} <b>x${i.qty}</b></span>`).join("");
        
        const mapBtn = `<button class="btn-table btn-map" title="Locate" onclick="openMap('${o.address}')"><i class="fas fa-map-marker-alt"></i></button>`;
        let actionButtons = "";
        
        if(o.status === 'Pending') {
            actionButtons = `${mapBtn} <button class="btn-table btn-accept" onclick="updateStatus('${o.id}', 'Accepted')">Accept</button>`;
        } else if(o.status === 'Accepted') {
            actionButtons = `${mapBtn} <button class="btn-table btn-ready" onclick="markReady('${o.id}', '${o.mobile}')">Ready</button>`;
        } else {
            actionButtons = `<span style="color:green; font-weight:600;">Completed</span>`;
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${timeStr} <br> <small style="color:#999;">#${o.id.slice(-4)}</small></td>
          <td>
            <b>${o.name}</b><br>
            <i class="fas fa-phone-alt" style="font-size:0.8rem; color:#aaa;"></i> ${o.mobile}<br>
            <span class="badge badge-type">${o.orderType || 'Delivery'}</span>
          </td>
          <td><div class="items-list">${itemsHtml}</div></td>
          <td><b style="color:var(--primary);">‚Çπ${o.total}</b><br><small>${o.paymentId ? 'Paid' : 'Unpaid'}</small></td>
          <td>${actionButtons}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- 7. ACTIONS ---
    function updateStatus(id, status) {
      db.collection("orders").doc(id).update({ status: status });
    }

    function markReady(id, mobile) {
      updateStatus(id, "Ready");
      if(confirm("Notify customer on WhatsApp?")) {
        const msg = "Hello! Your order from Do Bhai Chaap is READY and being dispatched. üõµ";
        window.open(`https://wa.me/91${mobile}?text=${encodeURIComponent(msg)}`);
      }
    }

    function openMap(address) {
        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`, '_blank');
    }

    function exportCSV() {
      let csv = "Date,Name,Mobile,Address,Items,Total,Status\n";
      ordersData.forEach(o => {
        const items = (o.items || []).map(i => `${i.name}(x${i.qty})`).join(" | ");
        csv += `"${o.created?.toDate() || ''}","${o.name}","${o.mobile}","${o.address}","${items}","${o.total}","${o.status}"\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "orders.csv";
      a.click();
    }
function renderList(elementId, data, type) {
    const container = document.getElementById(elementId);
    container.innerHTML = "";

    if(data.length === 0) {
        container.innerHTML = `<div class="empty-msg"><i class="fas fa-check-circle"></i><br>No orders here</div>`;
        return;
    }

    data.forEach(o => {
        const time = o.created ? o.created.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";
        
        const itemsHtml = (o.items || []).map(i => `<div>${i.name} <b>x${i.qty}</b></div>`).join("");
        
        // --- SMART MAP LOGIC START ---
        // Default: Search the written address
        let finalMapLink = `https://maps.google.com/maps?q=${encodeURIComponent(o.address)}`;
        
        // Smart: If a GPS link exists in the text, use THAT instead
        // This looks for "http" links inside the address text
        const gpsMatch = (o.address || "").match(/http[s]?:\/\/maps\.google\.com\/[^ \n]+/);
        if(gpsMatch) {
            finalMapLink = gpsMatch[0];
        }
        // --- SMART MAP LOGIC END ---

        let buttons = "";
        if(type === "pending") {
            buttons = `
                <button class="btn btn-map" onclick="window.open('${finalMapLink}')"><i class="fas fa-map-marker-alt"></i></button>
                <button class="btn btn-accept" onclick="updateStatus('${o.id}', 'Accepted')">Accept & Cook</button>
            `;
        } else if(type === "accepted") {
            buttons = `
                <button class="btn btn-ready" onclick="markReady('${o.id}', '${o.mobile}')">Mark Ready ‚úÖ</button>
            `;
        } else {
            buttons = `<div style="text-align:center; width:100%; color:#27ae60; font-weight:bold;">Completed</div>`;
        }

        const div = document.createElement("div");
        div.className = `card ${type}`;
        div.innerHTML = `
            <div class="card-header">
                <span>#${o.id.slice(-4)}</span>
                <span>${time}</span>
            </div>
            <div class="cust-details">
                ${o.name} <small>(${o.orderType || 'Delivery'})</small>
            </div>
            <div class="cust-address" onclick="window.open('${finalMapLink}')">
                 <i class="fas fa-location-arrow"></i> ${o.address}
            </div>
            <div class="items-box">
                ${itemsHtml}
                <div style="margin-top:5px; border-top:1px dashed #777; padding-top:5px; font-weight:bold;">
                    Total: ‚Çπ${o.total} <span style="font-size:0.8rem; font-weight:normal;">(${o.paymentId ? 'Paid' : 'Unpaid'})</span>
                </div>
            </div>
            <div class="actions">${buttons}</div>
        `;
        container.appendChild(div);
    });
  }
    // --- 8. SOUND ---
    function enableSound() {
      soundEnabled = true;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      playBeep();
      const btn = document.getElementById("soundBtn");
      btn.innerHTML = '<i class="fas fa-volume-up"></i> Sound Active';
      btn.classList.add("active");
      checkRinging();
    }

    function checkRinging() {
      const hasPending = ordersData.some(o => o.status === 'Pending');
      if(hasPending && soundEnabled && !ringInterval) startRinging();
      else if(!hasPending && ringInterval) stopRinging();
    }

    function startRinging() {
        ringInterval = setInterval(() => {
            if(audioCtx) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.setValueAtTime(600, audioCtx.currentTime + 0.15);
                gain.gain.value = 0.5;
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }, 2500);
    }

    function stopRinging() {
        clearInterval(ringInterval);
        ringInterval = null;
    }

    function playBeep() {
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = 600;
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest-admin.json">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#e91e63">
  <title>Admin Dashboard | Do Bhai Chaap Wale</title>

  <!-- Fonts & Icons (ORIGINAL) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- Firebase SDKs (ORIGINAL + messaging added) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

  <style>
    /* ================= ORIGINAL STYLES (PRESERVED) ================= */
    :root {
      --primary: #e91e63;
      --primary-dark: #c2185b;
      --bg-light: #f4f7fa;
      --sidebar-bg: #2d3436;
      --text-main: #333;
      --text-light: #777;
      --card-shadow: 0 4px 15px rgba(0,0,0,0.05);
      --success: #00b894;
      --warning: #fdcb6e;
      --info: #0984e3;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--bg-light);
      height: 100vh;
      overflow: hidden;
      color: var(--text-main);
    }

    .hidden { display: none; }

    /* ================= LOGIN (ORIGINAL) ================= */
    #login-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg,#2d3436,#000);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .login-card {
      background: #fff;
      padding: 35px;
      border-radius: 12px;
      width: 90%;
      max-width: 380px;
      text-align: center;
    }

    .login-card input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
    }

    .login-card button {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    /* ================= LAYOUT (ORIGINAL) ================= */
    #dashboard { display: flex; height: 100vh; }

    aside {
      width: 260px;
      background: var(--sidebar-bg);
      color: #fff;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    aside h1 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 30px;
    }

    .nav-item {
      padding: 14px;
      margin-bottom: 10px;
      border-radius: 8px;
      cursor: pointer;
      background: rgba(255,255,255,0.05);
    }

    .nav-item.active {
      background: rgba(255,255,255,0.15);
      border-left: 4px solid var(--primary);
    }

    main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .view-section { display: none; }
    .view-section.active { display: block; }

    /* ================= LIVE ORDERS CONTROLS (ORIGINAL) ================= */
    .controls-bar {
      background: #fff;
      padding: 10px 15px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      margin-bottom: 15px;
    }

    .status-tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .status-tab {
      padding: 8px 14px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      background: #eee;
    }

    .status-tab.active {
      background: var(--primary);
      color: #fff;
    }

    /* ================= TABLE (DESKTOP â€“ ORIGINAL) ================= */
    .table-container {
      background: #fff;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th, td {
      padding: 14px;
      border-bottom: 1px solid #eee;
    }

    /* ================= MOBILE CARDS (ADDED) ================= */
    .mobile-orders { display: none; }

    .order-card {
      background: #fff;
      border-radius: 12px;
      padding: 14px;
      box-shadow: var(--card-shadow);
      margin-bottom: 12px;
    }

    .order-card .top {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .order-card .name {
      font-weight: 700;
      margin-top: 6px;
    }

    .order-card .items {
      font-size: 0.85rem;
      margin: 8px 0;
    }

    .order-card .total {
      font-weight: 700;
      color: var(--primary);
    }

    .order-card .actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
    }

    .btn-accept { background: var(--success); }
    .btn-ready { background: var(--primary); }

    /* ================= PAYOUTS & STATS (ORIGINAL + MOVED) ================= */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      border-left: 5px solid var(--primary);
    }

    .stat-card h3 {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-light);
    }

    .stat-card .val {
      font-size: 1.8rem;
      font-weight: 700;
    }

    /* ================= MOBILE RESPONSIVE (ADDED) ================= */
    @media (max-width: 768px) {
      body { overflow: auto; }
      #dashboard { flex-direction: column; height: auto; }

      aside {
        width: 100%;
        flex-direction: row;
        overflow-x: auto;
      }

      aside h1 { display: none; }

      .nav-item {
        flex: 1;
        text-align: center;
        margin-bottom: 0;
        border-left: none;
        border-bottom: 3px solid transparent;
      }

      .nav-item.active {
        border-bottom-color: var(--primary);
      }

      table { display: none; }
      .mobile-orders { display: block; }
    }
  </style>
</head>

<body>

<!-- ================= LOGIN (ORIGINAL) ================= -->
<div id="login-overlay">
  <div class="login-card">
    <h2>Admin Panel</h2>
    <input id="adminUser" placeholder="Username">
    <input id="adminPass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>
</div>

<!-- ================= DASHBOARD ================= -->
<div id="dashboard" class="hidden">
  <aside>
    <h1>Do Bhai Chaap</h1>
    <div class="nav-item active" onclick="switchView('orders')">Live Orders</div>
    <div class="nav-item" onclick="switchView('payouts')">Payouts & Stats</div>
    <div class="nav-item" onclick="exportCSV()">Export</div>
    <div class="nav-item" onclick="logout()" style="margin-top:auto;color:#e91e63;">Logout</div>
  </aside>

  <main>

    <!-- ================= LIVE ORDERS ================= -->
    <div id="view-orders" class="view-section active">

      <button onclick="enableBackgroundRinging()" style="margin-bottom:10px;">
        ðŸ”” Enable Order Ringing
      </button>

      <div class="controls-bar">
        <div class="status-tabs">
          <div class="status-tab active" onclick="setFilter('Pending')">Pending</div>
          <div class="status-tab" onclick="setFilter('Accepted')">Kitchen</div>
          <div class="status-tab" onclick="setFilter('Ready')">History</div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTable"></tbody>
        </table>
      </div>

      <div id="mobileOrders" class="mobile-orders"></div>
    </div>

    <!-- ================= PAYOUTS & STATS ================= -->
    <div id="view-payouts" class="view-section">
      <h2>Payouts & Stats</h2>

      <div class="stats-grid">
        <div class="stat-card">
          <h3>Pending Orders</h3>
          <div class="val" id="stat-pending">0</div>
        </div>
        <div class="stat-card">
          <h3>Today's Orders</h3>
          <div class="val" id="stat-orders">0</div>
        </div>
        <div class="stat-card">
          <h3>Today's Revenue</h3>
          <div class="val" id="stat-today">â‚¹0</div>
        </div>
      </div>

      <div class="stat-card">
        <h3>Lifetime Revenue</h3>
        <div class="val" id="pay-total">â‚¹0</div>
      </div>
    </div>

  </main>
</div>

<script>
/* ================= FIREBASE CONFIG (ORIGINAL â€“ UNCHANGED) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyADDoSv7Wt8WOfYkcAYZcQOZtCKROuHMu4",
  authDomain: "dobhaichaapwale1.firebaseapp.com",
  projectId: "dobhaichaapwale1",
  storageBucket: "dobhaichaapwale1.firebasestorage.app",
  messagingSenderId: "141034963645",
  appId: "1:141034963645:web:442a93b6e87643b3bf2dd4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messaging = firebase.messaging();

/* ================= ORIGINAL LOGIN LOGIC ================= */
const ADMIN_USER = "admin";
const ADMIN_PASS = "A90Anshu@";

function login() {
  if (adminUser.value === ADMIN_USER && adminPass.value === ADMIN_PASS) {
    document.getElementById("login-overlay").style.display = "none";
    document.getElementById("dashboard").classList.remove("hidden");
    loadOrders();
  } else {
    loginError.innerText = "Wrong credentials";
  }
}

function logout() { location.reload(); }

/* ================= NAV ================= */
function switchView(v) {
  document.querySelectorAll(".view-section").forEach(s => s.classList.remove("active"));
  document.getElementById("view-" + v).classList.add("active");
}

/* ================= ORDERS LOGIC (PRESERVED) ================= */
let ordersData = [];
let currentFilter = "Pending";

function loadOrders() {
  db.collection("orders").orderBy("created", "desc")
    .onSnapshot(snap => {
      ordersData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderOrders();
      updateStats();
    });
}

function setFilter(f) {
  currentFilter = f;
  renderOrders();
}

function renderOrders() {
  const filtered = currentFilter === "Ready"
    ? ordersData.filter(o => o.status === "Ready" || o.status === "Completed")
    : ordersData.filter(o => (o.status || "Pending") === currentFilter);

  ordersTable.innerHTML = "";
  mobileOrders.innerHTML = "";

  filtered.forEach(o => {
    const time = o.created?.toDate ? o.created.toDate().toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"}) : "";
    const items = (o.items || []).map(i => `â€¢ ${i.name} x${i.qty}`).join("<br>");

    let btn = "";
    if ((o.status || "Pending") === "Pending")
      btn = `<button class="btn btn-accept" onclick="updateStatus('${o.id}','Accepted')">Accept</button>`;
    else if (o.status === "Accepted")
      btn = `<button class="btn btn-ready" onclick="updateStatus('${o.id}','Ready')">Ready</button>`;

    ordersTable.innerHTML += `
      <tr>
        <td>${time}</td>
        <td>${o.name}<br>${o.mobile}</td>
        <td>${items}</td>
        <td>â‚¹${o.total}</td>
        <td>${btn}</td>
      </tr>`;

    mobileOrders.innerHTML += `
      <div class="order-card">
        <div class="top"><span>#${o.id.slice(-4)}</span><span>${time}</span></div>
        <div class="name">${o.name} (${o.mobile})</div>
        <div class="items">${items}</div>
        <div class="total">â‚¹${o.total}</div>
        <div class="actions">${btn}</div>
      </div>`;
  });
}

function updateStatus(id, status) {
  db.collection("orders").doc(id).update({ status });
}

/* ================= STATS LOGIC (PRESERVED) ================= */
function updateStats() {
  document.getElementById("stat-pending").innerText =
    ordersData.filter(o => (o.status || "Pending") === "Pending").length;

  document.getElementById("stat-orders").innerText = ordersData.length;

  const today = new Date().toDateString();
  const todayRevenue = ordersData.filter(o =>
    o.created?.toDate && o.created.toDate().toDateString() === today
  ).reduce((a,b)=>a+Number(b.total||0),0);

  document.getElementById("stat-today").innerText = "â‚¹" + todayRevenue;
  document.getElementById("pay-total").innerText =
    "â‚¹" + ordersData.reduce((a,b)=>a+Number(b.total||0),0);
}

/* ================= CSV EXPORT (PRESERVED) ================= */
function exportCSV() {
  let csv = "Name,Mobile,Total,Status\n";
  ordersData.forEach(o => {
    csv += `${o.name},${o.mobile},${o.total},${o.status}\n`;
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv]));
  a.download = "orders.csv";
  a.click();
}

/* ================= ðŸ”” NOTIFICATIONS (ADDED, SAFE) ================= */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/firebase-messaging-sw.js")
    .then(reg => messaging.useServiceWorker(reg));
}

function enableBackgroundRinging() {
  Notification.requestPermission().then(p => {
    if (p !== "granted") {
      alert("Please allow notifications");
      return;
    }
    messaging.getToken().then(token => {
      if (!token) return;
      db.collection("adminTokens").doc(token).set({ created: new Date() });
      alert("ðŸ”” Loud order ringing enabled");
    });
  });
}

messaging.onMessage(() => {
  new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg").play();
  if (navigator.vibrate) navigator.vibrate([500,500,500,500]);
});
</script>

</body>
</html>

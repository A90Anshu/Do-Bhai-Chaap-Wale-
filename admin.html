<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest-admin.json">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#e91e63">
  <title>Admin Dashboard | Do Bhai Chaap Wale</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

  <style>
    /* ================= PROFESSIONAL THEME VARIABLES ================= */
    :root {
      --primary: #e91e63;
      --primary-hover: #d81b60;
      --primary-light: rgba(233, 30, 99, 0.1);
      
      --bg-body: #f3f4f6;
      --bg-surface: #ffffff;
      --bg-sidebar: #1f2937;
      
      --text-main: #111827;
      --text-muted: #6b7280;
      --text-light: #9ca3af;
      
      --border-color: #e5e7eb;
      
      --success: #10b981;
      --success-dark: #059669;
      --warning: #f59e0b;
      --info: #3b82f6;
      
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--bg-body);
      height: 100vh;
      overflow: hidden;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .hidden { display: none !important; }

    /* ================= LOGIN ================= */
    #login-overlay {
      position: fixed;
      inset: 0;
      background: #111827; /* Fallback */
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .login-card {
      background: var(--bg-surface);
      padding: 40px;
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: var(--shadow-lg);
    }

    .login-card h2 {
      margin-top: 0;
      margin-bottom: 25px;
      color: var(--primary);
      font-weight: 700;
    }

    .login-card input {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    .login-card input:focus {
      border-color: var(--primary);
    }

    .login-card button {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 10px;
    }

    .login-card button:hover { background: var(--primary-hover); }

    /* ================= LAYOUT ================= */
    #dashboard { display: flex; height: 100vh; }

    aside {
      width: 280px;
      background: var(--bg-sidebar);
      color: #fff;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 24px rgba(0,0,0,0.1);
      z-index: 10;
    }

    .sidebar-header {
      padding: 30px 20px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    aside h1 {
      font-size: 1.25rem;
      color: #fff;
      margin: 0;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    aside h1 span { color: var(--primary); }

    .nav-container {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .nav-item {
      padding: 14px 18px;
      border-radius: var(--radius-md);
      cursor: pointer;
      color: var(--text-light);
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-item:hover {
      background: rgba(255,255,255,0.05);
      color: #fff;
    }

    .nav-item.active {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 4px 12px rgba(233, 30, 99, 0.4);
    }

    main {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      background: var(--bg-body);
    }

    .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
    .view-section.active { display: block; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* ================= CONTROLS & HEADER ================= */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .controls-bar {
      background: var(--bg-surface);
      padding: 8px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      border: 1px solid var(--border-color);
    }

    .status-tab {
      padding: 8px 20px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .status-tab:hover { color: var(--primary); background: var(--primary-light); }

    .status-tab.active {
      background: var(--primary);
      color: #fff;
      box-shadow: var(--shadow-sm);
    }
    
    .action-btn {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      color: var(--text-main);
      padding: 10px 16px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      box-shadow: var(--shadow-sm);
    }
    
    .action-btn:hover { border-color: var(--primary); color: var(--primary); }

    /* ================= TABLE ================= */
    .table-container {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    thead {
      background: #f9fafb;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      padding: 16px 20px;
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 18px 20px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-main);
      font-size: 0.95rem;
    }

    tr:last-child td { border-bottom: none; }
    tr:hover { background: #f9fafb; }

    /* ================= BUTTONS ================= */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: var(--radius-sm);
      color: #fff;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.85rem;
      transition: transform 0.1s, opacity 0.2s;
    }

    .btn:active { transform: scale(0.98); }
    .btn:hover { opacity: 0.9; }

    .btn-accept { background: var(--success); box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); }
    .btn-ready { background: var(--primary); box-shadow: 0 2px 4px rgba(233, 30, 99, 0.3); }

    /* ================= STATS CARDS ================= */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-surface);
      padding: 25px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: transform 0.2s;
    }
    
    .stat-card:hover { transform: translateY(-3px); }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      background: var(--primary-light);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .stat-info { flex: 1; }

    .stat-card h3 {
      margin: 0 0 5px 0;
      font-size: 0.85rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .stat-card .val {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-main);
    }
    
    .stat-card.featured {
      background: linear-gradient(135deg, var(--primary) 0%, #c2185b 100%);
      color: #fff;
    }
    .stat-card.featured h3 { color: rgba(255,255,255,0.8); }
    .stat-card.featured .val { color: #fff; }
    .stat-card.featured .stat-icon { background: rgba(255,255,255,0.2); color: #fff; }

    /* ================= MOBILE ORDERS ================= */
    .mobile-orders { display: none; }

    .order-card {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
    }

    .order-card .top {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .order-card .name {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-main);
    }

    .order-card .items {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin: 12px 0;
      line-height: 1.5;
      background: #f9fafb;
      padding: 10px;
      border-radius: var(--radius-sm);
    }

    .order-card .total {
      font-weight: 700;
      color: var(--primary);
      font-size: 1.1rem;
      margin-bottom: 15px;
    }

    .order-card .actions { display: flex; gap: 10px; }
    .order-card .btn { flex: 1; padding: 12px; font-size: 1rem; }

    /* ================= RESPONSIVE ================= */
    @media (max-width: 768px) {
      body { overflow: auto; background: #f3f4f6; }
      #dashboard { flex-direction: column; height: auto; }

      aside {
        width: 100%;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }
      
      .sidebar-header { display: none; }

      .nav-container {
        flex-direction: row;
        overflow-x: auto;
        padding: 10px;
        gap: 10px;
      }

      .nav-item {
        flex: none;
        padding: 8px 16px;
        font-size: 0.9rem;
        background: rgba(255,255,255,0.05);
      }
      
      /* Hide Icon text on mobile if needed, or keeping it for clarity */
      .nav-item i { margin-right: 5px; }

      main { padding: 15px; }

      table { display: none; }
      .mobile-orders { display: block; }
      
      .controls-bar { width: 100%; justify-content: space-between; display: flex; margin-bottom: 15px; }
      .status-tab { padding: 8px 12px; font-size: 0.8rem; flex: 1; text-align: center; }
      
      .section-header { flex-direction: column; gap: 10px; align-items: flex-start; }
    }
  </style>
</head>

<body>

<div id="login-overlay">
  <div class="login-card">
    <h2>Admin Panel</h2>
    <input id="adminUser" placeholder="Username">
    <input id="adminPass" type="password" placeholder="Password">
    <button onclick="login()">Login <i class="fas fa-arrow-right" style="margin-left:5px;"></i></button>
    <p id="loginError" style="margin-top:15px; font-size:0.9rem;"></p>
  </div>
</div>

<div id="dashboard" class="hidden">
  <aside>
    <div class="sidebar-header">
      <h1>Do Bhai <span>Chaap</span></h1>
    </div>
    <div class="nav-container">
      <div class="nav-item active" onclick="switchView('orders')">
        <i class="fas fa-utensils"></i> Live Orders
      </div>
      <div class="nav-item" onclick="switchView('payouts')">
        <i class="fas fa-chart-pie"></i> Payouts & Stats
      </div>
      <div class="nav-item" onclick="exportCSV()">
        <i class="fas fa-file-csv"></i> Export Data
      </div>
      <div class="nav-item" onclick="logout()" style="margin-top:auto; color:#ff6b6b;">
        <i class="fas fa-sign-out-alt"></i> Logout
      </div>
    </div>
  </aside>

  <main>

    <div id="view-orders" class="view-section active">
      
      <div class="section-header">
        <div class="controls-bar">
          <div class="status-tabs">
            <div class="status-tab active" onclick="setFilter('Pending')">Pending</div>
            <div class="status-tab" onclick="setFilter('Accepted')">Kitchen</div>
            <div class="status-tab" onclick="setFilter('Ready')">History</div>
          </div>
        </div>
        
        <button class="action-btn" onclick="enableBackgroundRinging()">
          <i class="fas fa-bell"></i> Enable Sound
        </button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th width="15%"><i class="far fa-clock"></i> Time</th>
              <th width="25%"><i class="far fa-user"></i> Customer</th>
              <th width="35%"><i class="fas fa-hamburger"></i> Items</th>
              <th width="10%">Total</th>
              <th width="15%">Action</th>
            </tr>
          </thead>
          <tbody id="ordersTable"></tbody>
        </table>
      </div>

      <div id="mobileOrders" class="mobile-orders"></div>
    </div>

    <div id="view-payouts" class="view-section">
      <h2 style="margin-top:0; margin-bottom:20px; font-weight:600;">Analytics Overview</h2>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
          <div class="stat-info">
            <h3>Pending Orders</h3>
            <div class="val" id="stat-pending">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-receipt"></i></div>
          <div class="stat-info">
            <h3>Today's Orders</h3>
            <div class="val" id="stat-orders">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-rupee-sign"></i></div>
          <div class="stat-info">
            <h3>Today's Revenue</h3>
            <div class="val" id="stat-today">â‚¹0</div>
          </div>
        </div>
      </div>

      <div class="stat-card featured">
        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
        <div class="stat-info">
          <h3>Lifetime Revenue</h3>
          <div class="val" id="pay-total">â‚¹0</div>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
/* ================= FIREBASE CONFIG (ORIGINAL â€“ UNCHANGED) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyADDoSv7Wt8WOfYkcAYZcQOZtCKROuHMu4",
  authDomain: "dobhaichaapwale1.firebaseapp.com",
  projectId: "dobhaichaapwale1",
  storageBucket: "dobhaichaapwale1.firebasestorage.app",
  messagingSenderId: "141034963645",
  appId: "1:141034963645:web:442a93b6e87643b3bf2dd4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messaging = firebase.messaging();

/* ================= ORIGINAL LOGIN LOGIC ================= */
const ADMIN_USER = "admin";
const ADMIN_PASS = "A90Anshu@";

function login() {
  if (adminUser.value === ADMIN_USER && adminPass.value === ADMIN_PASS) {
    document.getElementById("login-overlay").style.display = "none";
    document.getElementById("dashboard").classList.remove("hidden");
    loadOrders();
  } else {
    loginError.innerText = "Wrong credentials";
  }
}

function logout() { location.reload(); }

/* ================= NAV ================= */
function switchView(v) {
  document.querySelectorAll(".view-section").forEach(s => s.classList.remove("active"));
  document.getElementById("view-" + v).classList.add("active");
  
  // Highlight nav
  document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
  // Simple check for highlighting (custom UI logic added without breaking IDs)
  const navs = document.querySelectorAll(".nav-item");
  if(v === 'orders') navs[0].classList.add("active");
  if(v === 'payouts') navs[1].classList.add("active");
}

/* ================= ORDERS LOGIC (PRESERVED) ================= */
let ordersData = [];
let currentFilter = "Pending";

function loadOrders() {
  db.collection("orders").orderBy("created", "desc")
    .onSnapshot(snap => {
      ordersData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderOrders();
      updateStats();
    });
}

function setFilter(f) {
  currentFilter = f;
  // Visual update for tabs
  const tabs = document.querySelectorAll('.status-tab');
  tabs.forEach(t => t.classList.remove('active'));
  event.target.classList.add('active'); // Assumes click event target
  
  renderOrders();
}

function renderOrders() {
  const filtered = currentFilter === "Ready"
    ? ordersData.filter(o => o.status === "Ready" || o.status === "Completed")
    : ordersData.filter(o => (o.status || "Pending") === currentFilter);

  ordersTable.innerHTML = "";
  mobileOrders.innerHTML = "";

  filtered.forEach(o => {
    const time = o.created?.toDate ? o.created.toDate().toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"}) : "";
    // Clean up item display with bold text
    const items = (o.items || []).map(i => `<b>${i.name}</b> <span style="color:#666; font-size:0.9em;">x${i.qty}</span>`).join("<br>");

    let btn = "";
    // Added icons to buttons
    if ((o.status || "Pending") === "Pending")
      btn = `<button class="btn btn-accept" onclick="updateStatus('${o.id}','Accepted')"><i class="fas fa-check"></i> Accept</button>`;
    else if (o.status === "Accepted")
      btn = `<button class="btn btn-ready" onclick="updateStatus('${o.id}','Ready')"><i class="fas fa-bell"></i> Ready</button>`;

    // Table Row
    ordersTable.innerHTML += `
      <tr>
        <td style="color:#555; font-weight:500;">${time}</td>
        <td><div style="font-weight:600; color:#111;">${o.name}</div><div style="font-size:0.85em; color:#777;">${o.mobile}</div></td>
        <td>${items}</td>
        <td style="font-weight:700; color:var(--primary);">â‚¹${o.total}</td>
        <td>${btn}</td>
      </tr>`;

    // Mobile Card
    mobileOrders.innerHTML += `
      <div class="order-card">
        <div class="top"><span>#${o.id.slice(-4)}</span><span>${time}</span></div>
        <div class="name">${o.name} <span style="font-weight:400; font-size:0.8em; color:#777;">(${o.mobile})</span></div>
        <div class="items">${items}</div>
        <div class="total">Total: â‚¹${o.total}</div>
        <div class="actions">${btn}</div>
      </div>`;
  });
}

function updateStatus(id, status) {
  db.collection("orders").doc(id).update({ status });
}

/* ================= STATS LOGIC (PRESERVED) ================= */
function updateStats() {
  document.getElementById("stat-pending").innerText =
    ordersData.filter(o => (o.status || "Pending") === "Pending").length;

  document.getElementById("stat-orders").innerText = ordersData.length;

  const today = new Date().toDateString();
  const todayRevenue = ordersData.filter(o =>
    o.created?.toDate && o.created.toDate().toDateString() === today
  ).reduce((a,b)=>a+Number(b.total||0),0);

  document.getElementById("stat-today").innerText = "â‚¹" + todayRevenue;
  document.getElementById("pay-total").innerText =
    "â‚¹" + ordersData.reduce((a,b)=>a+Number(b.total||0),0);
}

/* ================= CSV EXPORT (PRESERVED) ================= */
function exportCSV() {
  let csv = "Name,Mobile,Total,Status\n";
  ordersData.forEach(o => {
    csv += `${o.name},${o.mobile},${o.total},${o.status}\n`;
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv]));
  a.download = "orders.csv";
  a.click();
}

/* ================= ðŸ”” NOTIFICATIONS (SAFE) ================= */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/firebase-messaging-sw.js")
    .then(reg => messaging.useServiceWorker(reg));
}

function enableBackgroundRinging() {
  Notification.requestPermission().then(p => {
    if (p !== "granted") {
      alert("Please allow notifications");
      return;
    }
    messaging.getToken().then(token => {
      if (!token) return;
      db.collection("adminTokens").doc(token).set({ created: new Date() });
      alert("ðŸ”” Loud order ringing enabled");
    });
  });
}

messaging.onMessage(() => {
  new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg").play();
  if (navigator.vibrate) navigator.vibrate([500,500,500,500]);
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest-admin.json">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1e293b">
  <title>Admin Dashboard | Do Bhai Chaap Wale</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

  <style>
    /* ================= STYLES ================= */
    :root {
      --primary: #e91e63; --primary-hover: #be124e;
      --slate-900: #0f172a; --slate-800: #1e293b; --slate-700: #334155;
      --bg-body: #f8fafc; --text-main: #1e293b; --text-muted: #64748b;
      --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
    }
    * { box-sizing: border-box; outline: none; }
    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-body); height: 100vh; overflow: hidden; color: var(--text-main); }
    h1, h2, h3, .brand-font { font-family: 'Poppins', sans-serif; }
    .hidden { display: none !important; }

    /* LAYOUT */
    #dashboard { display: flex; height: 100vh; }
    aside { width: 270px; background: var(--slate-800); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; }
    .brand-header { padding: 25px; border-bottom: 1px solid var(--slate-700); }
    .nav-container { padding: 20px 10px; flex: 1; display: flex; flex-direction: column; gap: 5px; }
    .nav-item { padding: 12px 20px; border-radius: 8px; cursor: pointer; color: #94a3b8; display: flex; align-items: center; gap: 12px; font-weight: 500; transition: 0.2s; white-space: nowrap; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .nav-item.active { background: var(--primary); color: #fff; }
    main { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; }

    /* COMPONENTS */
    .header-bar { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
    .status-filter { background: #fff; padding: 5px; border-radius: 10px; border: 1px solid #e2e8f0; display: flex; overflow-x: auto; max-width: 100%; }
    .tab { padding: 8px 20px; border-radius: 8px; cursor: pointer; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; transition: 0.2s; white-space: nowrap; }
    .tab.active { background: var(--slate-800); color: #fff; }

    /* BUTTONS & ICONS */
    .btn { padding: 8px 16px; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; transition: 0.2s; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); }
    .btn-danger { background: var(--danger); }
    .btn-accept { background: var(--success); }
    .btn-ready { background: var(--info); }
    .btn-outline { background: #fff; border: 1px solid #cbd5e1; color: var(--slate-700); }
    .btn-icon { padding: 0; width: 32px; height: 32px; justify-content: center; border-radius: 6px; }
    .btn-move { background: #f1f5f9; color: var(--slate-700); border: 1px solid #e2e8f0; }
    .btn-move:hover { background: #e2e8f0; }

    /* TABLE */
    .table-card { background: #fff; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden; flex: 1; display: flex; flex-direction: column; }
    .table-wrapper { overflow-y: auto; flex: 1; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    thead th { position: sticky; top: 0; background: #f8fafc; padding: 15px; text-align: left; font-size: 0.85rem; color: var(--text-muted); border-bottom: 2px solid #e2e8f0; z-index: 10; }
    td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; vertical-align: middle; }

    /* SWITCH */
    .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--success); }
    input:checked + .slider:before { transform: translateX(18px); }

    /* CARDS & GRID */
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
    .info-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .stat-card { background: #fff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }
    .chart-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
    .top-items-card { background: #fff; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; }
    .item-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; }

    /* MODAL */
    #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
    .modal { background: #fff; padding: 25px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; color: #555; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }
    .variant-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .variant-row input { flex: 1; }

    /* MOBILE RESPONSIVE */
    .mobile-list { display: none; }
    @media (max-width: 900px) {
      body { overflow: auto; }
      #dashboard { flex-direction: column; height: auto; min-height: 100vh; }
      aside { width: 100%; position: sticky; top: 0; height: auto; flex-direction: row; padding: 10px; overflow-x: auto; white-space: nowrap; background: var(--slate-800); box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 100; }
      .brand-header { display: none; }
      .nav-container { flex-direction: row; padding: 0; width: 100%; gap: 10px; }
      .nav-item { background: rgba(255,255,255,0.1); flex: none; }
      main { padding: 15px; height: auto; overflow: visible; }
      .table-card { display: none !important; }
      .mobile-list { display: block; }
      .m-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
      .m-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; }
      .m-actions { display: flex; gap: 10px; flex-wrap: wrap; }
      .m-actions button { flex: 1; justify-content: center; padding: 12px; font-size: 1rem; }
      .header-bar { flex-direction: column; align-items: stretch; gap: 10px; }
      .status-filter { width: 100%; }
      .chart-container { grid-template-columns: 1fr; }
    }
    
    /* UTILS */
    #page-loader { position: fixed; inset: 0; background: #fff; z-index: 9999; display: none; justify-content: center; align-items: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #toast-box { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
    .toast { background: var(--slate-800); color: #fff; padding: 12px 20px; border-radius: 8px; margin-top: 10px; animation: slideIn 0.3s ease; border-left: 4px solid var(--primary); }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    
    #login-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #1e293b, #0f172a); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .login-card { background: rgba(255,255,255,0.95); padding: 40px; border-radius: 16px; width: 90%; max-width: 380px; text-align: center; }
    .login-card input { width: 100%; padding: 14px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 8px; }
    .login-card button { width: 100%; padding: 14px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
  </style>
</head>

<body>
<div id="toast-box"></div>
<div id="page-loader"><div class="spinner"></div></div>

<div id="modal-overlay">
  <div class="modal">
    <h3 id="modal-title">Add Menu Item</h3>
    <input type="hidden" id="edit-item-id">
    
    <div class="form-group"><label>Item Name</label><input id="inp-name" placeholder="e.g. Malai Chaap"></div>
    <div class="form-group"><label>Category</label><div style="display:flex; gap:10px;"><select id="inp-category" style="flex:1"></select><button class="btn btn-outline" onclick="promptNewCategory()">+ New</button></div></div>
    <div class="form-group"><label>Pricing Type</label><select id="inp-type-select" onchange="toggleVariantInputs()"><option value="single">Single Price</option><option value="variant">Variants (Half/Full)</option></select></div>
    <div id="price-single" class="form-group"><label>Price (‚Çπ)</label><input id="inp-price" type="number" placeholder="0"></div>
    <div id="price-variant" class="form-group hidden"><label>Variants</label><div class="variant-row"><input id="var-name-1" value="Half"><input id="var-price-1" type="number" placeholder="Price"></div><div class="variant-row"><input id="var-name-2" value="Full"><input id="var-price-2" type="number" placeholder="Price"></div></div>
    
    <div class="form-group" style="display:flex;align-items:center;gap:10px;">
        <input type="checkbox" id="inp-bestseller" style="width:auto;">
        <label for="inp-bestseller" style="margin:0;color:var(--primary);cursor:pointer;">Mark as Bestseller ‚≠ê</label>
    </div>
    
    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;">
        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveMenuItem()">Save Item</button>
    </div>
  </div>
</div>

<div id="login-overlay">
  <div class="login-card">
    <h2 class="brand-font" style="margin-top:0;">Admin Access</h2>
    <input id="adminUser" placeholder="Email"><input id="adminPass" type="password" placeholder="Password">
    <div style="text-align:left;margin-bottom:15px;font-size:0.9rem;color:#555;"><input type="checkbox" id="rememberMe" style="width:auto;"> <label for="rememberMe">Keep me logged in</label></div>
    <button onclick="login()">Sign In</button>
    <p id="loginError" style="color:var(--danger);margin-top:15px;"></p>
  </div>
</div>

<div id="dashboard" class="hidden">
  <aside>
    <div class="brand-header"><h1 class="brand-font" style="margin:0;">Do Bhai <span>Chaap</span></h1></div>
    <div class="nav-container">
      <div class="nav-item active" onclick="switchView('orders')"><i class="fas fa-list"></i> Live Orders</div>
      <div class="nav-item" onclick="switchView('menu')"><i class="fas fa-utensils"></i> Menu Inventory</div>
      <div class="nav-item" onclick="switchView('categories')"><i class="fas fa-layer-group"></i> Categories</div>
      <div class="nav-item" onclick="switchView('settings')"><i class="fas fa-cog"></i> Shop Settings</div>
      <div class="nav-item" onclick="switchView('coupons')"><i class="fas fa-tags"></i> Coupons</div>
      <div class="nav-item" onclick="switchView('payouts')"><i class="fas fa-chart-pie"></i> Analytics</div>
      <div class="nav-item" onclick="logout()" style="margin-top:auto; color:#f87171;"><i class="fas fa-power-off"></i> Logout</div>
    </div>
  </aside>

  <main>
    <div id="view-orders">
      <div class="header-bar">
        <h2 style="margin:0;">Live Orders</h2>
        <div class="status-filter">
          <div class="tab active" onclick="setFilter('Pending')">Pending</div>
          <div class="tab" onclick="setFilter('Accepted')">Kitchen</div>
          <div class="tab" onclick="setFilter('Ready')">Delivery</div>
          <div class="tab" onclick="setFilter('Completed')">History</div>
        </div>
        <button class="btn btn-outline" id="soundBtn" onclick="enableSound()">üîä Enable Ringing</button>
      </div>
      <div class="table-card"><div class="table-wrapper"><table><thead><tr><th>Time</th><th>Customer</th><th>Items</th><th>Total</th><th>Status</th></tr></thead><tbody id="ordersTable"></tbody></table></div></div>
      <div id="mobileOrders" class="mobile-list"></div>
    </div>

    <div id="view-menu" class="hidden">
      <div class="header-bar">
        <h2 style="margin:0;">Menu Inventory</h2>
        <div style="flex:1; display:flex; justify-content:center; gap:10px;">
            <button class="btn btn-outline" onclick="loadMenu('all')">All</button>
            <button class="btn btn-outline" onclick="loadMenu('lowstock')">Low Stock</button>
            <button class="btn btn-outline" onclick="loadMenu('bestseller')">Bestsellers</button>
        </div>
        <button class="btn btn-primary" onclick="openAddModal()">‚ûï Add New</button>
      </div>
      <div class="table-card"><div class="table-wrapper"><table><thead><tr><th>Sort</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Actions</th></tr></thead><tbody id="menuTable"></tbody></table></div></div>
      <div id="mobileMenu" class="mobile-list"></div>
    </div>

    <div id="view-categories" class="hidden">
      <div class="header-bar"><h2 style="margin:0;">Categories</h2><button class="btn btn-accept" style="margin-left:auto;" onclick="addCategory()">‚ûï Create Category</button></div>
      <div id="category-list" class="grid-container"></div>
    </div>

    <div id="view-settings" class="hidden">
      <h2 style="margin-bottom:20px;">Shop Settings</h2>
      <div style="background:#fff; padding:30px; border-radius:16px; max-width:600px;">
        <div class="form-group"><label>Shop Name</label><input id="cfg-name"></div>
        <div class="form-group"><label>Address</label><textarea id="cfg-address" rows="3"></textarea></div>
        <div class="form-group"><label>Maps Link</label><input id="cfg-map"></div>
        <button class="btn btn-primary" onclick="saveSettings()">Save Configuration</button>
      </div>
    </div>

    <div id="view-coupons" class="hidden">
      <div class="header-bar"><h2 style="margin:0;">Coupons</h2><button class="btn btn-accept" style="margin-left:auto;" onclick="addCoupon()">‚ûï Add Coupon</button></div>
      <div id="coupon-list" class="grid-container"></div>
    </div>

    <div id="view-payouts" class="hidden">
      <h2>Business Overview</h2>
      <div class="stats-grid">
        <div class="stat-card"><h4>Total Revenue</h4><div class="val" id="pay-total">‚Çπ0</div><div class="sub">Lifetime</div></div>
        <div class="stat-card"><h4>Today's Sales</h4><div class="val" id="pay-today" style="color:var(--primary)">‚Çπ0</div><div class="sub" id="count-today">0 Orders</div></div>
        <div class="stat-card"><h4>Pending</h4><div class="val" id="stat-pending">0</div><div class="sub">Actions needed</div></div>
      </div>
      <div class="chart-container">
        <div class="top-items-card"><h3 style="margin-top:0; margin-bottom:20px;">Top Items</h3><div id="top-items-list"></div></div>
        <div class="top-items-card"><h3 style="margin-top:0; margin-bottom:20px;">Order Status</h3><div id="status-breakdown" style="display:flex; gap:10px; flex-direction:column;"></div></div>
      </div>
      <button class="btn btn-outline" style="margin-top:20px;" onclick="exportCSV()">Export Full Data</button>
    </div>
  </main>
</div>

<script>
/* CONFIG */
const firebaseConfig = { apiKey: "AIzaSyADDoSv7Wt8WOfYkcAYZcQOZtCKROuHMu4", authDomain: "dobhaichaapwale1.firebaseapp.com", projectId: "dobhaichaapwale1", storageBucket: "dobhaichaapwale1.firebasestorage.app", messagingSenderId: "141034963645", appId: "1:141034963645:web:442a93b6e87643b3bf2dd4" };
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const messaging = firebase.messaging();

const alarmSound = new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");
alarmSound.loop = true; 
let wakeLock = null;
let currentEditingId = null;

/* INIT */
window.onload = function() {
    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');
            initApp();
        } else {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('dashboard').classList.add('hidden');
        }
    });
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('/firebase-messaging-sw.js');
};

function login() {
  const e = document.getElementById('adminUser').value;
  const p = document.getElementById('adminPass').value;
  if(e === "admin" && p === "A90Anshu@") {
      // Legacy bypass for quick access if auth fails, but prefer real auth
      document.getElementById('login-overlay').style.display='none'; document.getElementById('dashboard').classList.remove('hidden'); initApp();
      return;
  }
  auth.signInWithEmailAndPassword(e, p).catch(err => document.getElementById('loginError').innerText=err.message);
}
function logout() { auth.signOut(); location.reload(); }
function initApp() { loadOrders(); loadMenu(); loadSettings(); loadCategories(); loadCoupons(); }
function switchView(v) { ['orders','menu','settings','categories','coupons','payouts'].forEach(id=>document.getElementById('view-'+id).classList.add('hidden')); document.getElementById('view-'+v).classList.remove('hidden'); }

/* ORDERS */
let ordersData=[], currentFilter="Pending", isFirst=true;
function loadOrders() {
    db.collection("orders").orderBy("created", "desc").onSnapshot(snap => {
        const newOrders = snap.docs.map(d => ({id:d.id, ...d.data()}));
        const newPending = newOrders.filter(o=>(o.status||"Pending")==="Pending").length;
        const oldPending = ordersData.filter(o=>(o.status||"Pending")==="Pending").length;
        if(!isFirst && newPending > oldPending) { triggerAlarm(); showToast("üîî New Order!"); }
        ordersData=newOrders; renderOrders(); calculateAnalytics(); isFirst=false;
    });
}
function calculateAnalytics() {
    let total=0, today=0, count=0, pending=0, items={};
    const tStr = new Date().toDateString();
    ordersData.forEach(o => {
        const amt = Number(o.total||0);
        if(o.status==='Ready'||o.status==='Completed') { total+=amt; if(o.created?.toDate().toDateString()===tStr) { today+=amt; count++; } }
        if((o.status||"Pending")==="Pending") pending++;
        (o.items||[]).forEach(i => items[i.name] = (items[i.name]||0) + (Number(i.qty)||1));
    });
    document.getElementById('pay-total').innerText = "‚Çπ"+total; document.getElementById('stat-pending').innerText = pending;
    document.getElementById('pay-today').innerText = "‚Çπ"+today; document.getElementById('count-today').innerText = count + " Orders";
    
    // Top Items
    const top = Object.entries(items).sort((a,b)=>b[1]-a[1]).slice(0,5);
    document.getElementById('top-items-list').innerHTML = top.map(([n,q])=>`<div class="item-row"><span>${n}</span><b>${q}</b></div>`).join('');
}
function triggerAlarm() { alarmSound.currentTime=0; alarmSound.play().catch(()=>{}); }
function stopAlarm() { alarmSound.pause(); alarmSound.currentTime=0; }
function updOrder(id, s) { db.collection("orders").doc(id).update({status:s}); stopAlarm(); }
function setFilter(f) { currentFilter=f; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); event.target.classList.add('active'); renderOrders(); }
function renderOrders() {
    const f = ordersData.filter(o => { const s = o.status||"Pending"; return currentFilter==="Ready" ? (s==="Ready"||s==="Completed") : s===currentFilter; });
    const tbody = document.getElementById('ordersTable'); const mlist = document.getElementById('mobileOrders');
    tbody.innerHTML=""; mlist.innerHTML="";
    f.forEach(o => {
        const iHtml = (o.items||[]).map(i=>`<div>${i.name} x${i.qty}</div>`).join('');
        let btns = "";
        if((o.status||"Pending")==="Pending") btns = `<button class="btn btn-accept" onclick="updOrder('${o.id}','Accepted')">Accept</button>`;
        else if(o.status==="Accepted") btns = `<button class="btn btn-ready" onclick="updOrder('${o.id}','Ready')">Mark Ready</button>`;
        else if(o.status==="Ready") btns = `<button class="btn btn-accept" onclick="updOrder('${o.id}','Completed')">Mark Delivered</button>`;
        else btns = `<span style="color:green;font-weight:bold">Completed</span>`;
        
        tbody.innerHTML += `<tr><td>${o.created?.toDate?o.created.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):''}</td><td><b>${o.name}</b><br>${o.mobile}</td><td>${iHtml}</td><td>‚Çπ${o.total}</td><td>${btns}</td></tr>`;
        mlist.innerHTML += `<div class="m-card"><div class="m-header"><b>${o.name}</b> <b>‚Çπ${o.total}</b></div><div class="m-body">${iHtml}</div><div class="m-actions">${btns.replace('btn','btn style="width:100%"')}</div></div>`;
    });
}

/* MENU WITH DRAG & DROP LOGIC */
let fullMenu = [];
function loadMenu(filter='all') {
    db.collection("menu").orderBy("sortOrder", "asc").onSnapshot(snap => {
        fullMenu = snap.docs.map((doc, idx) => {
            // Auto-heal missing sortOrder
            if(doc.data().sortOrder === undefined) db.collection("menu").doc(doc.id).update({sortOrder: idx});
            return {id: doc.id, ...doc.data()};
        });
        renderMenuTable(filter);
    });
}

function renderMenuTable(filter) {
    const tbody = document.getElementById('menuTable'); const mlist = document.getElementById('mobileMenu');
    tbody.innerHTML = ""; mlist.innerHTML = "";
    
    let display = fullMenu;
    if(filter === 'lowstock') display = fullMenu.filter(i => !i.available);
    if(filter === 'bestseller') display = fullMenu.filter(i => i.isBestseller);

    display.forEach((m, idx) => {
        let price = (m.type==="variant"&&m.variants) ? m.variants.map(v=>`${v.name}:‚Çπ${v.price}`).join(", ") : `‚Çπ${m.price}`;
        const actions = `
            <div style="display:flex; gap:5px; align-items:center;">
                <button class="btn btn-move btn-icon" onclick="moveItem(${idx}, -1)" title="Up"><i class="fas fa-arrow-up"></i></button>
                <button class="btn btn-move btn-icon" onclick="moveItem(${idx}, 1)" title="Down"><i class="fas fa-arrow-down"></i></button>
                <label class="switch" style="margin:0 5px"><input type="checkbox" ${m.available?'checked':''} onchange="db.collection('menu').doc('${m.id}').update({available:this.checked})"><span class="slider"></span></label>
                <button class="btn btn-outline btn-icon" onclick='openEditModal(${JSON.stringify(m)})'><i class="fas fa-pencil"></i></button>
                <button class="btn btn-outline btn-icon" onclick='duplicateItem(${JSON.stringify(m)})'><i class="fas fa-copy"></i></button>
                <button class="btn btn-danger btn-icon" onclick="if(confirm('Delete?')) db.collection('menu').doc('${m.id}').delete()"><i class="fas fa-trash"></i></button>
            </div>`;
        
        tbody.innerHTML += `<tr><td>#${m.sortOrder||idx+1}</td><td><b>${m.name}</b> ${m.isBestseller?'‚≠ê':''}</td><td>${m.category}</td><td>${price}</td><td>${m.available?'In Stock':'Out'}</td><td>${actions}</td></tr>`;
        mlist.innerHTML += `<div class="m-card"><div class="m-header"><b>${m.name}</b> <small>${price}</small></div><div class="m-actions" style="justify-content:space-between">${actions}</div></div>`;
    });
}

function moveItem(index, direction) {
    const targetIndex = index + direction;
    if (targetIndex < 0 || targetIndex >= fullMenu.length) return; // Out of bounds

    const itemA = fullMenu[index];
    const itemB = fullMenu[targetIndex];

    // Swap sortOrder
    const batch = db.batch();
    const orderA = itemA.sortOrder || index;
    const orderB = itemB.sortOrder || targetIndex;

    // Force strict swap
    batch.update(db.collection("menu").doc(itemA.id), { sortOrder: orderB });
    batch.update(db.collection("menu").doc(itemB.id), { sortOrder: orderA });

    batch.commit().then(() => showToast("Order Updated"));
}

/* CATEGORIES */
function loadCategories() {
    db.collection("categories").orderBy("name").onSnapshot(snap => {
        const d = document.getElementById("category-list"), s = document.getElementById("inp-category");
        d.innerHTML = ""; s.innerHTML = "";
        snap.forEach(doc => {
            const cat = doc.data().name;
            d.innerHTML += `<div class="info-card"><span class="card-title">${cat}</span><button class="btn btn-danger" onclick="if(confirm('Delete?')) db.collection('categories').doc('${doc.id}').delete()"><i class="fas fa-trash"></i></button></div>`;
            s.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
    });
}
function addCategory() { const n = prompt("Category Name:"); if(n) db.collection("categories").add({name:n}); }
function promptNewCategory() { const n = prompt("Category Name:"); if(n) db.collection("categories").add({name:n}); }

/* MODALS */
function openAddModal() { 
    currentEditingId = null; 
    document.getElementById('modal-title').innerText="Add Item"; 
    document.getElementById('inp-name').value=""; document.getElementById('inp-price').value=""; 
    document.getElementById('modal-overlay').style.display='flex'; 
}
function openEditModal(m) {
    currentEditingId = m.id;
    document.getElementById('modal-title').innerText="Edit Item";
    document.getElementById('inp-name').value = m.name;
    document.getElementById('inp-category').value = m.category;
    document.getElementById('inp-bestseller').checked = m.isBestseller;
    const t = document.getElementById('inp-type-select'); t.value = m.type||'single'; toggleVariantInputs();
    if(m.type==='variant' && m.variants) {
        if(m.variants[0]) { document.getElementById('var-name-1').value=m.variants[0].name; document.getElementById('var-price-1').value=m.variants[0].price; }
        if(m.variants[1]) { document.getElementById('var-name-2').value=m.variants[1].name; document.getElementById('var-price-2').value=m.variants[1].price; }
    } else document.getElementById('inp-price').value = m.price;
    document.getElementById('modal-overlay').style.display='flex';
}
function duplicateItem(m) {
    let n = {...m}; delete n.id; n.name += " (Copy)"; n.sortOrder = (fullMenu.length + 1);
    db.collection("menu").add(n).then(()=>showToast("Duplicated"));
}
function closeModal() { document.getElementById('modal-overlay').style.display='none'; }
function toggleVariantInputs() {
    const t = document.getElementById('inp-type-select').value;
    document.getElementById('price-single').classList.toggle('hidden', t==='variant');
    document.getElementById('price-variant').classList.toggle('hidden', t==='single');
}
function saveMenuItem() {
    const name = document.getElementById('inp-name').value;
    const cat = document.getElementById('inp-category').value;
    const type = document.getElementById('inp-type-select').value;
    const best = document.getElementById('inp-bestseller').checked;
    let data = { name, category: cat, type, isBestseller: best, available: true };
    
    if(type === 'variant') {
        const v1n = document.getElementById('var-name-1').value, v1p = document.getElementById('var-price-1').value;
        const v2n = document.getElementById('var-name-2').value, v2p = document.getElementById('var-price-2').value;
        if(!v1p) return alert("Price required");
        data.variants = [{name:v1n, price:Number(v1p)}];
        if(v2p) data.variants.push({name:v2n, price:Number(v2p)});
    } else {
        const p = document.getElementById('inp-price').value;
        if(!p) return alert("Price required");
        data.price = Number(p);
    }

    if(currentEditingId) db.collection("menu").doc(currentEditingId).update(data).then(()=>{ closeModal(); showToast("Updated"); });
    else { 
        data.sortOrder = fullMenu.length + 1; // New item goes to bottom
        db.collection("menu").add(data).then(()=>{ closeModal(); showToast("Added"); }); 
    }
}

/* SETTINGS & COUPONS */
function loadSettings() { db.collection("settings").doc("config").get().then(d=>{ if(d.exists) { const v=d.data(); document.getElementById('cfg-name').value=v.shopName||""; document.getElementById('cfg-address').value=v.address||""; document.getElementById('cfg-map').value=v.mapLink||""; } }); }
function saveSettings() { db.collection("settings").doc("config").set({ shopName:document.getElementById('cfg-name').value, address:document.getElementById('cfg-address').value, mapLink:document.getElementById('cfg-map').value }, {merge:true}).then(()=>showToast("Saved")); }
function loadCoupons() { db.collection("coupons").onSnapshot(snap=>{ const l=document.getElementById('coupon-list'); l.innerHTML=""; snap.forEach(d=>{ const c=d.data(); l.innerHTML+=`<div class="info-card"><div><b>${c.code}</b><br>${c.desc}</div><button class="btn btn-danger" onclick="db.collection('coupons').doc('${d.id}').delete()">Del</button></div>`; }); }); }
function addCoupon() { const c=prompt("Code:"), d=prompt("Desc:"); if(c) db.collection("coupons").add({code:c, desc:d}); }

/* UTILS */
function exportCSV() {
  let csv = "Name,Mobile,Total,Status\n"; ordersData.forEach(o => csv += `${o.name},${o.mobile},${o.total},${o.status}\n`);
  const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv])); a.download = "orders.csv"; a.click();
}
function showToast(msg) { const b=document.getElementById('toast-box'), d=document.createElement('div'); d.className='toast'; d.innerHTML=`üîî ${msg}`; b.appendChild(d); setTimeout(()=>d.remove(),3000); }
async function enableSound() {
    try { alarmSound.play().then(()=>{ alarmSound.pause(); alarmSound.currentTime=0; }); if('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); showToast("Screen Awake"); } Notification.requestPermission(); document.getElementById('soundBtn').style.background="#dcfce7"; document.getElementById('soundBtn').innerText="Active"; } catch(err) { alert("Click again!"); }
}
</script>
</body>
</html>

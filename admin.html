<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Kitchen Admin | Do Bhai Chaap</title>
  
  <link rel="manifest" href="manifest-admin.json">
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --primary: #e91e63;
      --success: #27ae60;
      --warning: #f39c12;
      --bg: #121212;
      --card-bg: #1e1e1e;
      --text: #ffffff;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin:0; font-family:'Poppins',sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }
    
    /* LOGIN OVERLAY */
    #login-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:999; display:flex; align-items:center; justify-content:center; }
    .login-box { background:#1e1e1e; padding:30px; border-radius:12px; width:90%; max-width:350px; text-align:center; border:1px solid #333; }
    .login-box input { width:100%; padding:12px; margin:10px 0; border-radius:6px; border:none; background:#333; color:#fff; }
    .login-box button { width:100%; padding:12px; background:var(--primary); color:#fff; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }

    /* HEADER */
    header { background:#000; padding:15px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; z-index: 10; }
    .logo { font-size:1.1rem; font-weight:700; color:var(--primary); }
    .sound-btn { background:#333; color:#fff; border:none; padding:8px 12px; border-radius:20px; cursor:pointer; font-size:0.8rem; display:flex; align-items:center; gap:5px; }
    .sound-btn.active { background:var(--primary); animation: pulse 1.5s infinite; }

    /* TABS (STICKY TOP) */
    .tabs { display:flex; background:#000; padding:0; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 9; }
    .tab { flex:1; padding:15px 5px; text-align:center; cursor:pointer; border-bottom:3px solid #333; color:#777; font-weight:600; font-size: 0.9rem; transition:0.2s; }
    .tab.active { color:var(--primary); border-bottom-color:var(--primary); background: rgba(233,30,99,0.1); }
    .tab-badge { background:var(--primary); color:#fff; padding:2px 6px; border-radius:10px; font-size:0.7rem; margin-left:3px; display:none; vertical-align: text-top; }

    /* CONTENT AREA */
    main { flex:1; overflow-y:auto; padding:10px; -webkit-overflow-scrolling: touch; padding-bottom: 80px; width: 100%; max-width: 800px; margin: 0 auto; }
    .order-section { display:none; }
    .order-section.active { display:block; animation: fadeIn 0.3s ease; }
    
    /* ORDER CARD */
    .card { background:var(--card-bg); border-radius:12px; padding:15px; margin-bottom:15px; border-left:5px solid #555; position:relative; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .card.pending { border-left-color:var(--warning); background: linear-gradient(145deg, #2c2518, #1e1e1e); }
    .card.accepted { border-left-color:var(--primary); }
    .card.ready { border-left-color:var(--success); opacity:0.7; }

    .card-header { display:flex; justify-content:space-between; margin-bottom:12px; font-size:0.85rem; color:#888; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
    .cust-details { font-size:1.1rem; font-weight:600; margin-bottom:8px; display:flex; align-items:center; justify-content: space-between; }
    .order-type { font-size: 0.75rem; background: #333; padding: 2px 8px; border-radius: 4px; color: #ccc; }
    
    /* ADDRESS BUTTON */
    .cust-address { 
      font-size:0.9rem; color:#ddd; display:flex; align-items:flex-start; gap:10px; margin-bottom:15px; 
      background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; cursor:pointer; line-height: 1.4;
    }
    .cust-address i { color: #3498db; margin-top: 3px; }

    .items-box { background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:15px; font-size:0.95rem; line-height:1.6; border: 1px solid #333; }
    .item-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #444; padding-bottom: 4px; margin-bottom: 4px; }
    
    /* ACTIONS BUTTONS */
    .actions { display:grid; grid-template-columns: 1fr 3fr; gap:10px; }
    .btn { padding:14px; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; gap:8px; }
    .btn:active { transform: scale(0.98); }
    .btn-map { background:#3498db; color:#fff; }
    .btn-accept { background:var(--success); color:#fff; }
    .btn-ready { background:var(--primary); color:#fff; width: 100%; grid-column: span 2; }

    /* EMPTY STATE */
    .empty-msg { text-align:center; color:#555; margin-top:80px; }
    .empty-msg i { font-size:3rem; margin-bottom:10px; opacity: 0.5; }

    @keyframes pulse { 0% {box-shadow:0 0 0 0 rgba(233,30,99,0.7);} 70% {box-shadow:0 0 0 10px rgba(233,30,99,0);} 100% {box-shadow:0 0 0 0 rgba(233,30,99,0);} }
    @keyframes fadeIn { from{opacity:0; transform: translateY(5px);} to{opacity:1; transform: translateY(0);} }
  </style>
</head>
<body>

<div id="login-overlay">
  <div class="login-box">
    <h2 style="color:var(--primary); margin-top:0;">Admin Login</h2>
    <input type="password" id="adminPass" placeholder="Enter Password">
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red; margin-top:10px; font-size:0.9rem;"></p>
  </div>
</div>

<div id="app" style="display:none; height:100vh; flex-direction:column;">
  <header>
    <div class="logo">ðŸ”¥ Kitchen Panel</div>
    <button class="sound-btn" id="soundBtn" onclick="enableSound()">
      <i class="fas fa-volume-mute"></i> Sound
    </button>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('pending')">
      Pending <span id="badge-pending" class="tab-badge">0</span>
    </div>
    <div class="tab" onclick="switchTab('accepted')">
      Cooking <span id="badge-accepted" class="tab-badge">0</span>
    </div>
    <div class="tab" onclick="switchTab('ready')">
      Ready
    </div>
  </div>

  <main>
    <div id="view-pending" class="order-section active">
      <div id="list-pending"></div>
    </div>
    <div id="view-accepted" class="order-section">
      <div id="list-accepted"></div>
    </div>
    <div id="view-ready" class="order-section">
      <div id="list-ready"></div>
    </div>
  </main>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
  // CONFIG
  const ADMIN_PASS = "A90Anshu@"; 
  const firebaseConfig = {
    apiKey: "AIzaSyADDoSv7Wt8WOfYkcAYZcQOZtCKROuHMu4",
    authDomain: "dobhaichaapwale1.firebaseapp.com",
    projectId: "dobhaichaapwale1",
    storageBucket: "dobhaichaapwale1.firebasestorage.app",
    messagingSenderId: "141034963645",
    appId: "1:141034963645:web:442a93b6e87643b3bf2dd4"
  };
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  
  let orders = [];
  let ringInterval = null;
  let audioEnabled = false;
  let audioCtx = null;

  // --- LOGIN ---
  function login() {
    const pass = document.getElementById("adminPass").value;
    if(pass === ADMIN_PASS) {
        document.getElementById("login-overlay").style.display = "none";
        document.getElementById("app").style.display = "flex";
        initApp();
    } else {
        document.getElementById("loginError").innerText = "Wrong Password";
    }
  }

  function initApp() {
    db.collection("orders").orderBy("created", "desc").limit(50).onSnapshot(snap => {
        orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
        renderAll();
    });
  }

  // --- SOUND ---
  function enableSound() {
    audioEnabled = true;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    playBeep();
    const btn = document.getElementById("soundBtn");
    btn.innerHTML = '<i class="fas fa-volume-up"></i> ON';
    btn.classList.add("active");
  }

  function playBeep() {
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.type = "square";
    osc.frequency.setValueAtTime(440, audioCtx.currentTime);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.1);
  }

  function startRinging() {
    if(!audioEnabled || ringInterval) return;
    ringInterval = setInterval(() => {
        if(audioCtx) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.setValueAtTime(600, audioCtx.currentTime + 0.15);
            gain.gain.value = 0.5;
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }
    }, 2500);
  }

  function stopRinging() {
    if(ringInterval) { clearInterval(ringInterval); ringInterval = null; }
  }

  // --- RENDER ---
  function renderAll() {
    const pending = orders.filter(o => !o.status || o.status === "Pending");
    const accepted = orders.filter(o => o.status === "Accepted");
    const ready = orders.filter(o => o.status === "Ready");

    updateBadge("pending", pending.length);
    updateBadge("accepted", accepted.length);

    renderList("list-pending", pending, "pending");
    renderList("list-accepted", accepted, "accepted");
    renderList("list-ready", ready, "ready");

    if(pending.length > 0) startRinging(); else stopRinging();
  }

  function renderList(elementId, data, type) {
    const container = document.getElementById(elementId);
    container.innerHTML = "";

    if(data.length === 0) {
        container.innerHTML = `<div class="empty-msg"><i class="fas fa-check-circle"></i><br>No orders</div>`;
        return;
    }

    data.forEach(o => {
        const time = o.created ? o.created.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";
        
        // --- SMART MAP LOGIC (Corrected) ---
        // 1. Default to searching the address text
        let mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(o.address)}`;
        
        // 2. Check if a GPS link was pasted (look for 'http' in the address)
        const gpsMatch = (o.address || "").match(/http[s]?:\/\/[^\s]+/);
        if(gpsMatch) {
            mapUrl = gpsMatch[0]; // Use the exact link provided by user
        }
        
        const itemsHtml = (o.items || []).map(i => 
            `<div class="item-row"><span>${i.name}</span> <b>x${i.qty}</b></div>`
        ).join("");

        let buttons = "";
        if(type === "pending") {
            buttons = `
                <button class="btn btn-map" onclick="window.open('${mapUrl}', '_blank')"><i class="fas fa-map-marker-alt"></i></button>
                <button class="btn btn-accept" onclick="updateStatus('${o.id}', 'Accepted')">Accept Order</button>
            `;
        } else if(type === "accepted") {
            buttons = `
                <button class="btn btn-ready" onclick="markReady('${o.id}', '${o.mobile}')">Mark Ready & Notify âœ…</button>
            `;
        } else {
             buttons = `<div style="text-align:center; padding:10px; color:#555; font-size:0.8rem;">Completed</div>`;
        }

        const div = document.createElement("div");
        div.className = `card ${type}`;
        div.innerHTML = `
            <div class="card-header">
                <span>#${o.id.slice(-4)}</span>
                <span>${time}</span>
            </div>
            <div class="cust-details">
                ${o.name} <span class="order-type">${o.orderType || 'Delivery'}</span>
            </div>
            <div class="cust-address" onclick="window.open('${mapUrl}', '_blank')">
                 <i class="fas fa-location-arrow"></i> 
                 <div>${o.address}</div>
            </div>
            <div class="items-box">
                ${itemsHtml}
                <div style="margin-top:8px; border-top:1px solid #444; padding-top:8px; font-weight:bold; color:var(--primary);">
                    Total: â‚¹${o.total} <span style="color:#888; font-weight:normal; font-size:0.8rem;">(${o.paymentId ? 'Paid' : 'COD'})</span>
                </div>
            </div>
            <div class="actions">${buttons}</div>
        `;
        container.appendChild(div);
    });
  }

  function updateStatus(id, status) {
    db.collection("orders").doc(id).update({ status: status });
  }

  function markReady(id, mobile) {
    updateStatus(id, "Ready");
    if(confirm("Notify on WhatsApp?")) {
        const msg = "Your order from Do Bhai Chaap is READY! ðŸ›µ";
        window.open(`https://wa.me/91${mobile}?text=${encodeURIComponent(msg)}`);
    }
  }

  function switchTab(tab) {
    document.querySelectorAll(".order-section").forEach(el => el.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
    
    document.getElementById(`view-${tab}`).classList.add("active");
    
    // Highlight correct tab
    const tabs = document.querySelectorAll(".tab");
    if(tab === 'pending') tabs[0].classList.add("active");
    if(tab === 'accepted') tabs[1].classList.add("active");
    if(tab === 'ready') tabs[2].classList.add("active");
  }

  function updateBadge(type, count) {
    const el = document.getElementById(`badge-${type}`);
    if(count > 0) { el.innerText = count; el.style.display = "inline-block"; } 
    else { el.style.display = "none"; }
  }
</script>
</body>
</html>

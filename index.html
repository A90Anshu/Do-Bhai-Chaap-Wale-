<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#ff5252">
  <title>Order Online | Do Bhai Chaap Wale</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    /* VARIABLES */
    :root { --primary:#ff5252; --primary-soft:#ffebee; --bg:#f4f6f8; --text:#1c1c1c; --gray:#696969; --success:#26a541; --radius:12px; }
    * { box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; }
    body { margin:0; font-family:'Plus Jakarta Sans',sans-serif; background:var(--bg); color:var(--text); padding-bottom:100px; }
    
    /* HEADER */
    header { background:#fff; padding:15px; position:sticky; top:0; z-index:99; box-shadow:0 2px 10px rgba(0,0,0,0.03); }
    .top-bar { display:flex; justify-content:space-between; align-items:center; }
    .brand h1 { margin:0; font-size:1.1rem; color:var(--primary); font-weight:800; }
    .status { background:var(--bg); padding:5px 10px; border-radius:20px; font-size:0.75rem; font-weight:700; }
    .status.active { background:#e8f5e9; color:var(--success); }

    /* COUPONS */
    .offers-scroll { display:flex; gap:12px; overflow-x:auto; padding:15px; scrollbar-width:none; }
    .offer-card { min-width:260px; background:linear-gradient(135deg,#2c3e50,#000); color:#fff; padding:15px; border-radius:var(--radius); box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    .offer-card h3 { margin:0; font-size:1.1rem; }
    
    /* MENU */
    .cat-scroll { display:flex; gap:10px; overflow-x:auto; padding:10px 15px; background:#fff; border-bottom:1px solid #eee; }
    .cat-chip { white-space:nowrap; padding:8px 16px; background:#f9f9f9; border:1px solid #eee; border-radius:50px; font-weight:600; font-size:0.85rem; color:var(--gray); transition:0.2s; cursor:pointer; }
    .cat-chip.active { background:var(--primary); color:#fff; border-color:var(--primary); }
    
    .menu-grid { padding:15px; display:grid; gap:15px; }
    .menu-card { background:#fff; padding:15px; border-radius:var(--radius); box-shadow:0 2px 8px rgba(0,0,0,0.04); position:relative; }
    .bestseller-tag { position:absolute; top:-8px; left:-8px; background:#f59e0b; color:#fff; font-size:0.6rem; padding:4px 8px; border-radius:4px; font-weight:800; text-transform:uppercase; z-index:10; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    
    .item-top { display:flex; justify-content:space-between; align-items:flex-start; }
    .item-name { font-weight:700; font-size:1rem; margin-bottom:4px; display:flex; align-items:center; gap:6px; }
    .veg-dot { width:12px; height:12px; border:1px solid var(--success); padding:2px; display:inline-block; border-radius:2px; }
    .veg-dot div { width:6px; height:6px; background:var(--success); border-radius:50%; }
    
    .btn-add { background:#fff; color:var(--success); border:1px solid #eee; padding:8px 25px; border-radius:8px; font-weight:800; font-size:0.9rem; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    
    /* VARIANT MODAL */
    #variant-modal { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:2000; display:none; justify-content:center; align-items:center; }
    .v-card { background:#fff; width:90%; max-width:350px; border-radius:16px; padding:20px; animation:popIn 0.2s; }
    @keyframes popIn { from{transform:scale(0.9)} to{transform:scale(1)} }
    .v-opt { display:flex; justify-content:space-between; padding:12px; border:1px solid #eee; border-radius:8px; margin-bottom:10px; cursor:pointer; font-weight:600; }
    .v-opt:hover { border-color:var(--primary); background:var(--primary-soft); color:var(--primary); }

    /* CART & BOTTOM NAV */
    .fab-cart { position:fixed; bottom:90px; left:15px; right:15px; background:#111; color:#fff; padding:16px; border-radius:12px; display:none; justify-content:space-between; align-items:center; box-shadow:0 10px 30px rgba(0,0,0,0.2); z-index:800; }
    .bottom-nav { position:fixed; bottom:0; width:100%; background:#fff; display:flex; justify-content:space-around; padding:12px 0; box-shadow:0 -5px 20px rgba(0,0,0,0.05); z-index:900; }
    .nav-icon { text-align:center; color:#ccc; font-size:0.75rem; font-weight:600; }
    .nav-icon.active { color:var(--primary); } .nav-icon i { display:block; font-size:1.4rem; margin-bottom:4px; }
    
    /* UTILS */
    .hidden { display:none !important; }
    section { display:none; animation:fadeIn 0.3s; } section.active { display:block; } @keyframes fadeIn { from{opacity:0}to{opacity:1} }
    #toast { visibility:hidden; min-width:250px; background:#333; color:#fff; text-align:center; border-radius:50px; padding:12px; position:fixed; z-index:2000; left:50%; bottom:100px; transform:translateX(-50%); }
    #toast.show { visibility:visible; animation:fadein 0.5s, fadeout 0.5s 2.5s; } @keyframes fadein { from{bottom:80px; opacity:0;} to{bottom:100px; opacity:1;} } @keyframes fadeout { from{bottom:100px; opacity:1;} to{bottom:80px; opacity:0;} }
    
    /* FORM & CART STYLES */
    .cart-box { background:#fff; padding:20px; border-radius:12px; margin:15px; }
    input, textarea { width:100%; padding:14px; background:#f9f9f9; border:1px solid #eee; border-radius:10px; margin-bottom:12px; font-family:inherit; }
    .btn-primary { width:100%; padding:15px; background:var(--primary); color:#fff; border:none; border-radius:10px; font-weight:700; font-size:1rem; }
    .type-opt { flex:1; text-align:center; padding:10px; background:#fff; border-radius:8px; font-weight:600; color:#999; }
    .type-opt.selected { background:#fff; color:var(--primary); box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<header>
  <div class="top-bar">
    <div class="brand"><h1>Do Bhai Chaap</h1><small id="shop-addr-short" style="color:#777">Pure Veg ‚Ä¢ Nangloi</small></div>
    <div id="user-status" class="status">Guest</div>
  </div>
</header>

<section id="menu-view" class="active">
  
  <div style="padding:15px; background:#fff;">
    <input type="text" id="search" placeholder="Search for Chaap, Rolls..." style="width:100%; padding:12px; border-radius:50px; border:1px solid #eee; background:#f9f9f9;" onkeyup="filterMenu()">
  </div>

  <div id="cat-scroll" class="cat-scroll">
      </div>
  
  <div id="coupon-scroll" class="offers-scroll">
      </div>

  <div id="menu-list" class="menu-grid">
    <div style="text-align:center; padding:40px; color:#999;">Loading Menu...</div>
  </div>
  
  <div style="margin:20px 15px; padding:20px; background:#fff; border-radius:12px; text-align:center;">
      <h3 style="margin-top:0;">üìç Visit Us</h3>
      <p id="footer-addr" style="color:#666; font-size:0.9rem;">Loading address...</p>
      <a id="footer-map" href="#" target="_blank" style="color:var(--primary); font-weight:700; text-decoration:none;">Open in Google Maps</a>
  </div>
</section>

<div id="variant-modal" onclick="if(event.target===this) this.style.display='none'">
    <div class="v-card">
        <h3 id="v-title" style="margin-top:0;">Select Size</h3>
        <div id="v-options"></div>
        <button onclick="document.getElementById('variant-modal').style.display='none'" style="width:100%; padding:10px; border:none; background:#eee; border-radius:8px; margin-top:10px;">Cancel</button>
    </div>
</div>

<section id="cart-view">
  <div class="cart-box">
    <h2 style="margin-top:0;">Your Cart</h2>
    <div id="cart-list"><p style="color:#999; text-align:center;">Empty Cart</p></div>
    <div style="display:flex; justify-content:space-between; margin-top:15px; border-top:1px dashed #eee; padding-top:15px;">
       <span>Total</span><span id="cart-total-display" style="font-weight:800;">‚Çπ0</span>
    </div>
  </div>

  <div id="checkout-form" class="cart-box">
    <div style="display:flex; background:#f0f0f0; padding:4px; border-radius:10px; margin-bottom:20px;">
        <div class="type-opt selected" id="opt-del" onclick="setType('Delivery')">Delivery</div>
        <div class="type-opt" id="opt-take" onclick="setType('Takeaway')">Takeaway</div>
    </div>
    <input id="c-name" placeholder="Name">
    <input id="c-phone" type="tel" placeholder="Mobile">
    <textarea id="c-addr" placeholder="Address"></textarea>
    <button onclick="checkout()" id="btn-pay" class="btn-primary">Place Order</button>
  </div>
  
  <div id="success-msg" class="cart-box hidden" style="text-align:center;">
    <h2 style="color:var(--success)">Order Placed!</h2>
    <p>Please send order to WhatsApp.</p>
    <button id="wa-btn" class="btn-primary" style="background:#25D366">WhatsApp</button>
  </div>
</section>

<section id="orders-view"><div class="cart-box"><h2>History</h2><div id="history-list">Login to view history</div></div></section>
<section id="profile-view"><div class="cart-box">
    <h2>Profile</h2>
    <div id="login-box">
        <input id="l-phone" placeholder="Mobile Number"><div id="recaptcha"></div>
        <button onclick="sendOTP()" class="btn-primary">Login</button>
        <div id="otp-area" class="hidden" style="margin-top:10px;">
            <input id="l-otp" placeholder="OTP">
            <button onclick="verifyOTP()" class="btn-primary">Verify</button>
        </div>
    </div>
    <div id="user-box" class="hidden">
        <p>Logged in as <b id="u-mobile"></b></p>
        <button onclick="logout()" class="btn-primary" style="background:#333">Logout</button>
    </div>
</div></section>

<div id="fab-cart" class="fab-cart" onclick="nav('cart')">
  <div><span id="fab-count">0 ITEMS</span> | <span id="fab-total">‚Çπ0</span></div>
  <div>View Cart <i class="fas fa-arrow-right"></i></div>
</div>

<div class="bottom-nav">
  <div class="nav-icon active" onclick="nav('menu')"><i class="fas fa-utensils"></i><br>Menu</div>
  <div class="nav-icon" onclick="nav('orders')"><i class="fas fa-receipt"></i><br>Orders</div>
  <div class="nav-icon" onclick="nav('profile')"><i class="fas fa-user"></i><br>Profile</div>
</div>

<div id="toast"></div>

<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
const firebaseConfig = { apiKey: "AIzaSyADDoSv7Wt8WOfYkcAYZcQOZtCKROuHMu4", authDomain: "dobhaichaapwale1.firebaseapp.com", projectId: "dobhaichaapwale1", storageBucket: "dobhaichaapwale1.firebasestorage.app", messagingSenderId: "141034963645", appId: "1:141034963645:web:442a93b6e87643b3bf2dd4" };
const RAZORPAY_KEY = "rzp_live_IAwVGH2rtMwKWw";

let db, auth, menu=[], cart=[], user=null, orderType="Delivery", confirmRes=null;

window.onload = () => {
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.firestore(); auth = firebase.auth();
    
    // FETCH SETTINGS (Address/Map)
    db.collection("settings").doc("config").get().then(doc => {
        if(doc.exists) {
            const d = doc.data();
            document.getElementById("footer-addr").innerText = d.address || "Nangloi, New Delhi";
            document.getElementById("footer-map").href = d.mapLink || "#";
        }
    });

    // FETCH CATEGORIES
    db.collection("categories").orderBy("name").onSnapshot(snap => {
        const d = document.getElementById("cat-scroll");
        d.innerHTML = `<div class="cat-chip active" onclick="filterCat('All')">All</div>`;
        snap.forEach(doc => {
            d.innerHTML += `<div class="cat-chip" onclick="filterCat('${doc.data().name}')">${doc.data().name}</div>`;
        });
    });

    // FETCH MENU
    db.collection("menu").where("available", "==", true).onSnapshot(snap => {
        menu = [];
        snap.forEach(d => menu.push({id:d.id, ...d.data()}));
        renderMenu(menu);
    });
    
    // FETCH COUPONS
    db.collection("coupons").onSnapshot(snap => {
        const d = document.getElementById("coupon-scroll"); d.innerHTML="";
        snap.forEach(doc => { const c=doc.data(); d.innerHTML+=`<div class="offer-card"><h3>${c.code}</h3><p>${c.desc}</p></div>`; });
    });

    // AUTH
    auth.onAuthStateChanged(u => {
        user = u;
        if(u) {
            document.getElementById("user-status").innerText = "Member";
            document.getElementById("user-status").classList.add("active");
            document.getElementById("login-box").classList.add("hidden");
            document.getElementById("user-box").classList.remove("hidden");
            document.getElementById("u-mobile").innerText = u.phoneNumber;
            loadHistory();
        } else {
            document.getElementById("user-status").innerText = "Guest";
            document.getElementById("user-status").classList.remove("active");
            document.getElementById("login-box").classList.remove("hidden");
            document.getElementById("user-box").classList.add("hidden");
        }
    });
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha', {size:'invisible'});
};

// --- NAVIGATION ---
function nav(tab) {
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.nav-icon').forEach(n=>n.classList.remove('active'));
    document.getElementById(tab+'-view').classList.add('active');
    const idx = {'menu':0, 'orders':1, 'profile':2};
    if(idx[tab]!==undefined) document.querySelectorAll('.nav-icon')[idx[tab]].classList.add('active');
}

// --- MENU & CART ---
function renderMenu(list) {
    const d = document.getElementById("menu-list"); d.innerHTML = "";
    if(!list.length) { d.innerHTML="<p style='text-align:center;color:#999'>No items found.</p>"; return; }
    
    // Sort: Bestsellers first
    list.sort((a,b) => (b.isBestseller===true) - (a.isBestseller===true));

    list.forEach(i => {
        const star = i.isBestseller ? `<div class="bestseller-tag">Bestseller ‚≠ê</div>` : "";
        
        let priceDisplay = "";
        let actionBtn = "";

        if(i.type === 'variant' && i.variants) {
            // Price range for display
            const prices = i.variants.map(v => v.price);
            priceDisplay = `‚Çπ${Math.min(...prices)} - ‚Çπ${Math.max(...prices)}`;
            // Open Variant Modal
            actionBtn = `<button class="btn-add" onclick='openVariantModal(${JSON.stringify(i)})'>ADD</button>`;
        } else {
            priceDisplay = `‚Çπ${i.price}`;
            actionBtn = `<button class="btn-add" onclick="addCart('${i.name}', ${i.price})">ADD</button>`;
        }

        d.innerHTML += `
        <div class="menu-card">
            ${star}
            <div class="item-top">
                <div style="flex:1">
                    <div class="item-name"><div class="veg-dot"><div></div></div> ${i.name}</div>
                    <div style="font-weight:600; color:#555;">${priceDisplay}</div>
                </div>
                <div style="margin-left:10px;">${actionBtn}</div>
            </div>
        </div>`;
    });
}

// --- VARIANT HANDLING ---
function openVariantModal(item) {
    const modal = document.getElementById("variant-modal");
    const title = document.getElementById("v-title");
    const opts = document.getElementById("v-options");
    
    title.innerText = item.name;
    opts.innerHTML = "";
    
    item.variants.forEach(v => {
        opts.innerHTML += `
        <div class="v-opt" onclick="addCart('${item.name} (${v.name})', ${v.price}); document.getElementById('variant-modal').style.display='none'">
            <span>${v.name}</span>
            <span>‚Çπ${v.price}</span>
        </div>`;
    });
    
    modal.style.display = "flex";
}

function filterCat(cat) {
    document.querySelectorAll('.cat-chip').forEach(c=>c.classList.remove('active')); event.target.classList.add('active');
    renderMenu(cat==='All' ? menu : menu.filter(i => i.category === cat));
}
function filterMenu() { const q = document.getElementById("search").value.toLowerCase(); renderMenu(menu.filter(i=>i.name.toLowerCase().includes(q))); }

function addCart(name, price) {
    const exists = cart.find(i=>i.name===name);
    if(exists) exists.qty++; else cart.push({name, price, qty:1});
    updateCart(); toast(`Added ${name}`);
    if(navigator.vibrate) navigator.vibrate(50);
}
function updateCart() {
    const d = document.getElementById("cart-list"); d.innerHTML="";
    if(!cart.length) { d.innerHTML="<p style='text-align:center;color:#999'>Empty</p>"; document.getElementById("fab-cart").style.display="none"; return; }
    let total=0, count=0;
    cart.forEach(i => {
        total += i.price*i.qty; count+=i.qty;
        d.innerHTML += `<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee"><span>${i.name} <small>x${i.qty}</small></span><span>‚Çπ${i.price*i.qty}</span></div>`;
    });
    document.getElementById("cart-total-display").innerText = "‚Çπ"+total;
    document.getElementById("fab-total").innerText = "‚Çπ"+total;
    document.getElementById("fab-count").innerText = count+" ITEMS";
    document.getElementById("fab-cart").style.display="flex";
}

// --- CHECKOUT ---
function setType(t) { 
    orderType=t; 
    document.getElementById("opt-del").classList.toggle("selected", t==="Delivery");
    document.getElementById("opt-take").classList.toggle("selected", t==="Takeaway");
    document.getElementById("c-addr").style.display = t==="Takeaway" ? "none" : "block";
}
function checkout() {
    if(!cart.length) return toast("Cart empty");
    const name=document.getElementById("c-name").value, phone=document.getElementById("c-phone").value, addr=document.getElementById("c-addr").value;
    if(!name || !phone) return toast("Name & Phone required");
    if(orderType==="Delivery" && !addr) return toast("Address required");
    
    const total = cart.reduce((a,b)=>a+(b.price*b.qty),0);
    const options = { key: RAZORPAY_KEY, amount: total*100, currency: "INR", name: "Do Bhai Chaap", 
        handler: function(r){ saveOrder(name, phone, addr, total, r.razorpay_payment_id); } 
    };
    new Razorpay(options).open();
}
function saveOrder(name, phone, addr, total, pid) {
    db.collection("orders").add({
        name, mobile:phone, address: orderType==="Takeaway"?"Takeaway":addr, 
        items: cart, total, paymentId: pid, status: "Pending", 
        created: firebase.firestore.FieldValue.serverTimestamp(),
        userId: user ? user.uid : null
    });
    const items = cart.map(i=>`${i.name} x${i.qty}`).join('%0A');
    const msg = `*NEW ORDER (${orderType})*%0A${name} - ${phone}%0AItems:%0A${items}%0ATotal: ‚Çπ${total}`;
    document.getElementById("wa-btn").onclick = () => window.open(`https://wa.me/918700494451?text=${msg}`);
    document.getElementById("checkout-form").classList.add("hidden");
    document.getElementById("success-msg").classList.remove("hidden");
    cart=[]; updateCart();
}

// --- HISTORY & AUTH ---
function loadHistory() {
    db.collection("orders").where("userId","==",user.uid).orderBy("created","desc").limit(10).onSnapshot(s => {
        const d = document.getElementById("history-list"); d.innerHTML="";
        if(s.empty) d.innerHTML="<p style='text-align:center'>No orders yet.</p>";
        s.forEach(doc => {
            const o = doc.data();
            d.innerHTML += `<div style="background:#f9f9f9;padding:10px;margin-bottom:10px;border-radius:8px;">
                <div style="display:flex;justify-content:space-between;font-weight:bold"><span>${o.created?.toDate().toLocaleDateString()}</span><span>${o.status}</span></div>
                <div style="font-size:0.9rem;color:#666">${o.items.map(i=>i.name).join(', ')}</div>
                <div style="text-align:right;font-weight:bold;margin-top:5px">‚Çπ${o.total}</div>
            </div>`;
        });
    });
}
function sendOTP() {
    const p = document.getElementById("l-phone").value;
    auth.signInWithPhoneNumber("+91"+p, window.recaptchaVerifier).then(c => { confirmRes=c; document.getElementById("otp-area").classList.remove("hidden"); toast("OTP Sent"); });
}
function verifyOTP() {
    confirmRes.confirm(document.getElementById("l-otp").value).then(()=>toast("Logged In")).catch(()=>toast("Invalid OTP"));
}
function logout() { auth.signOut(); location.reload(); }
function toast(m) { const t=document.getElementById("toast"); t.innerText=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),3000); }
</script>
</body>
</html>
